const Promise = require('bluebird');
const fs      = Promise.promisifyAll(require('graceful-fs'));

module.exports = [
  {
    id: 'P64:php:phpinfo',
    name: 'Matches any PHP script containing a call to phpinfo()',
    description: 'phpinfo() is a useful way of showing the current server configuration in a human-readable format, however is exposes some sensitive information to potential attackers. This rule detects PHP scripts that contain this function call as this could be the indication of a script created maliciously.',
    urls: null,
    deprecated: false,
    tags: ['suspicion', 'php', 'phpinfo'],
    test: (f) => {
      if (!f.match(/\.php$/i))
        return Promise.resolve(false);

      // Some WordPress internal files include safe calls to phpinfo(), so exclude them
      if (
        f.match(/wp-includes\/functions\.php$/i) ||
        f.match(/wp-admin\/includes\/class-wp-filesystem-ssh2\.php/i)
      )
        return Promise.resolve(false);

      return fs.readFileAsync(f)
        .then(lines =>
          lines.toString().match(/phpinfo\(/) &&
          !lines.toString().match(/\/\/\s+phpinfo\(/)
        );
    },
  },
];
