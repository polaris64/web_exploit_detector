const Promise = require('bluebird');
const fs      = Promise.promisifyAll(require('graceful-fs'));

module.exports = [
  {
    id: 'P64:php:cms:wordpress:wso_webshell',
    name: 'Matches any PHP scripts that contain the wso WebShell exploit',
    description: '',
    urls: null,
    deprecated: false,
    tags: ['php', 'cms', 'wordpress', 'wso', 'webshell'],
    test: (f) => {
      if (!f.match(/\.php$/i))
        return Promise.resolve(false);
      if (f.match(/wp-info\.php$/i))
        return Promise.resolve(true);
      return fs.readFileAsync(f)
        .then(lines => lines.toString().match(/wsoex/i));
    },
  },

  {
    id: 'P64:php:cms:wordpress:wp_cd_code',
    name: 'Matches any PHP scripts that contain malicious code contained in a variable called "wp_cd_code"',
    description: '',
    urls: ['https://www.polaris64.net/blog/cyber-security/2017/wordpress-hacks-functions-php-backdoors'],
    deprecated: false,
    tags: ['php', 'cms', 'wordpress', 'wp_cd_code'],
    test: (f) => {
      if (!f.match(/\.php$/i))
        return Promise.resolve(false);
      return fs.readFileAsync(f)
        .then(lines => lines.toString().match(/wp_cd_code/i));
    },
  },

  {
    id: 'P64:php:cms:wordpress:php_in_uploads',
    name: 'Matches PHP scripts within the "wp-content/uploads" directory structure that are > 27 bytes',
    description: 'PHP scripts in the wp-content/uploads directory of a WordPress installation could be malicious, but also could be legitimate. This rule detects any PHP script that is bigger than 27 bytes so as to avoid matching any empty placeholder scripts (e.g. index.php scripts with the "silence is golden" comment).',
    urls: null,
    deprecated: false,
    tags: ['php', 'cms', 'wordpress', 'uploads'],
    test: (f) => {
      if (!f.match(/wp-content\/uploads\/.*\.php$/i))
        return Promise.resolve(false);
      return fs.statAsync(f)
        .then(stat => stat.size > 27);
    },
  },
];
